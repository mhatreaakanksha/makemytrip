pipeline {
   options {
     buildDiscarder(logRotator(numToKeepStr: '5' , artifactNumToKeepStr: '5' ))
   }
   agent any

   tools {
       maven 'maven_3.9.4'
    }

  stages {
      stage('code compilation')  {
         steps {
              echo 'code compilation is in progress!'
              sh 'mvn clean compile'
              echo 'code compilation is completed successfully!'

         }
      }
        stage('code QA Execution') {
           steps {
                echo 'junit test case check in progress!'
                sh 'mvn clean test'
                echo 'junit test case check completed!'

           }
        }
          stage('code package') {
               steps {
                  echo 'Creating War Artifact'
                  sh 'mvn clean package'
                  echo 'Creating War Artifact Done'

                   }
                }


                stage('Building & Tag Docker Image') {
                            steps {
                                echo 'Starting Building Docker Image'
                                sh 'docker build -t mhatreaakanksha/makemytrip:dev-makemytrip-v.1.${BUILD_NUMBER} .'
                                sh 'docker build -t makemytrip:dev-makemytrip-v.1.${BUILD_NUMBER} .'

                                 echo 'Completed  Building Docker Image'
                            }
                        }
                        stage('Docker Image Scanning') {
                            steps {
                                echo 'Docker Image Scanning Started'
                                sh 'java -version'

                            }
                        }

                        stage(' Docker push to Docker Hub') {
                                   steps {
                                      script {
                                         withCredentials([string(credentialsId: 'dockerhubCred', variable: 'dockerhubCred')]){
                                         sh 'docker login docker.io -u mhatreaakanksha -p ${dockerhubCred}'
                                         echo "Push Docker Image to DockerHub : In Progress"
                                         sh 'docker push mhatreaakanksha/makemytrip:dev-makemytrip-v.1.${BUILD_NUMBER} '
                                         sh 'docker push mhatreaakanksha/makemytrip:dev-makemytrip-v.1.${BUILD_NUMBER}'
                                         echo "Push Docker Image to DockerHub : In Progress"
                                         sh 'whoami'
                                         }
                                      }
                                    }
                   }
                                stage(' Docker Image Push to Amazon ECR') {
                                   steps {
                                      script {
                                         withDockerRegistry([credentialsId:'ecr:ap-south-1:ecr-credentials', url:"https://068215304716.dkr.ecr.ap-south-1.amazonaws.com"]){
                                         sh """
                                         echo "List the docker images present in local"
                                         docker images
                                         echo "Tagging the Docker Image: In Progress"
                                         docker tag makemytrip:latest 068215304716.dkr.ecr.ap-south-1.amazonaws.com/makemytrip:dev-makemytrip-v.1.${BUILD_NUMBER}
                                         echo "Tagging the Docker Image: Completed"
                                         echo "Push Docker Image to ECR : In Progress"
                                         docker push 068215304716.dkr.ecr.ap-south-1.amazonaws.com/makemytrip:dev-makemytrip-v.1.${BUILD_NUMBER}
                                         echo "Push Docker Image to ECR : Completed"
                                         """
                                         }
                                      }
                              }
}


                stage('Upload the docker Image to Nexus') {
                   steps {
                    script {
                  withCredentials([usernamePassword(credentialsId: 'nexus-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]){
                  sh 'docker login https://13.232.117.178:8085/repository/makemytrip/ -u admin -p ${PASSWORD}'
                  echo "Push Docker Image to Nexus : In Progress"
                  sh 'docker tag makemytrip 13.232.117.178:8085/makemytrip:dev-makemytrip-v.1.${BUILD NUMBER}'
                  echo "Tagging the Docker Image: Completed"
                  sh 'docker push 13.232.117.178:8085/makemytrip'
                  echo "Push Docker Image to Nexus : Completed"
                 }
              }
            }
    }

  }
}

















